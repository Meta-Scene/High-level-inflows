# 高位资金净流出股票交易策略API

本项目实现了一种基于资金流量分析的股票交易策略API，专注于识别高位资金净流出的情况下的买卖点。

## 项目架构

- `app.py` - API服务主程序，提供HTTP接口
- `data_processor.py` - 数据处理模块，负责股票数据的计算和信号生成
- `db_utils.py` - 数据库工具，包含数据库连接和查询函数
- `signal_calculator.py` - 信号计算器，实现买卖点判定算法

## 安装与启动

### 依赖安装

```bash
pip install -r requirements.txt
```

### 启动服务

```bash
python run.py
```

启动后，服务会在后台执行以下步骤：
1. 创建或检查必要的数据库索引，优化查询性能
2. 检查数据库中是否已有信号数据，若无则进行首次计算
3. 启动API服务，默认监听0.0.0.0:5000

## API端点说明

### 主要端点

- **GET /api/stocks** - 获取有买卖点信号的股票数据（最近20个交易日内）
- **GET /api/stocks/{ts_code}** - 获取单只股票数据，例如: `/api/stocks/000001.SZ`
- **GET /api/returns** - 获取所有股票的收益率统计
- **GET /api/all-stocks** - 获取数据库中所有股票的完整列表（不只限于有信号的股票）
- **GET /api/refresh** - 强制刷新计算结果，支持优化参数
- **GET /api/index** - 创建或更新数据库索引以提升查询性能

### 性能优化参数

`/api/refresh`端点支持以下优化参数：

- **optimized=true|false** - 是否使用优化计算（默认为true）
- **batch_size=整数** - 批处理大小（默认为100）

例如：
- `/api/refresh?batch_size=50` - 使用批大小为50的优化计算
- `/api/refresh?optimized=false` - 使用常规计算方式

## 数据格式说明

### 返回数据格式

```json
{
  "column_names": ["ts_code", "trade_date", "open", "high", "low", "close", "pre_close", "pct_chg", "vol", "bay", "ma120", "ma250", "name", "sell"],
  "data": [
    [
      ["000001.SZ", "2023-02-19", 11.8, 11.81, 11.68, 11.71, 11.81, -0.85, 1177748.95, 11.71, 11.26, 10.83, "平安银行", 0.0],
      // ... 更多数据
    ]
  ],
  "page": 1,
  "stock_count": 1,
  "total_stocks": 4000,
  "date_range": {
    "start": "2023-02-01",
    "end": "2023-02-20",
    "days": 20
  }
}
```

### 字段说明

- `bay`: 买点价格，如果有买点信号则显示买入价格（当日收盘价），否则为0.0
- `sell`: 卖点价格，如果有卖点信号则显示卖出价格（当日收盘价），否则为0.0
- `ma120`: 120日移动平均线
- `ma250`: 250日移动平均线

## 买卖点信号计算逻辑

### 买入信号条件

- 价格处于低位（低于5日简单移动平均线的95%）
- 成交量放大（比前一天高10%以上）
- 价格上涨（比前一天高）

### 卖出信号条件（高位资金净流出）

- 价格处于高位（高于5日简单移动平均线）
- 成交量放大（比前一天高10%以上）
- 价格下跌（比前一天低）

## 性能优化

本API已进行以下优化以提高性能：

1. 为关键字段添加数据库索引（ts_code、trade_date等）
2. 使用批处理优化股票数据计算，减少数据库连接开销
3. 使用更高效的SQL查询减少数据库负载
4. 支持批量处理，适合处理大量股票数据

## 数据库说明

系统使用PostgreSQL数据库存储股票数据，主要表结构如下：

### all_stocks_days表

股票每日交易数据表，包含基本交易信息。

### high_level_inflows表

高位资金流出信号表，记录买卖点信号和收益率数据。

## 使用示例

获取最近有买卖点信号的股票列表：

```
GET http://localhost:5000/api/stocks
```

获取单只股票详细数据：

```
GET http://localhost:5000/api/stocks/000001.SZ
```

强制刷新计算结果（使用优化批量处理，每批100只股票）：

```
GET http://localhost:5000/api/refresh?batch_size=100
```

创建或更新数据库索引以提升性能：

```
GET http://localhost:5000/api/index
``` 